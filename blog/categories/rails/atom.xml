<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: rails | Syntax Error]]></title>
  <link href="http://andreamazz.github.io/blog/categories/rails/atom.xml" rel="self"/>
  <link href="http://andreamazz.github.io/"/>
  <updated>2015-02-04T11:03:00+01:00</updated>
  <id>http://andreamazz.github.io/</id>
  <author>
    <name><![CDATA[Andrea Mazzini]]></name>
    <email><![CDATA[andrea@fancypixel.it]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[React + Flux backed by Rails API]]></title>
    <link href="http://andreamazz.github.io/blog/2015/02/04/react-plus-flux-backed-by-rails-api/"/>
    <updated>2015-02-04T11:01:00+01:00</updated>
    <id>http://andreamazz.github.io/blog/2015/02/04/react-plus-flux-backed-by-rails-api</id>
    <content type="html"><![CDATA[<p>I’ve been working on a frontend for a project we are developing here at Fancy Pixel. We are embracing what looks like a good habit: slicing what would be a monolithic Rails app in a lightweight backend serving APIs and a frontend consuming them. We did this in the not so distant past using Angular.js. It was all fine and dandy, until it wasn’t. There’s something about it that doesn’t sit right with me, I wouldn’t go in detail, since many others already did, but let’s just say that there’s too much magic involved for my tastes (says the guy using Rails). Magic is fine as long as I can figure out how to tinker with the internals when things go down south. With Angular the effort seems too much, but that’s just personal taste really. Also I can’t deny that the major structural changes introduced in 2.0 were the last nail in the coffin.
I wanted to try something new, something that would enforce a solid architecture of our apps, letting me control the single cogs in the engine. React got a lot of good press in the past months, so I took the chance to dive in. In this three-part post you’ll find pretty much everything I learned by writing a frontend using React, with a vanilla Flux architecture, consuming an API written in Rails.</p>

<p>Read the full article <a href="http://fancypixel.github.io/blog/2015/01/28/react-plus-flux-backed-by-rails-api/">here</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[React + Flux backed by Rails API - Part 2]]></title>
    <link href="http://andreamazz.github.io/blog/2015/01/29/react-plus-flux-backed-by-rails-api-part-2/"/>
    <updated>2015-01-29T10:31:00+01:00</updated>
    <id>http://andreamazz.github.io/blog/2015/01/29/react-plus-flux-backed-by-rails-api-part-2</id>
    <content type="html"><![CDATA[<p>This is the second part of &ldquo;React + Flux backed by Rails API&rdquo;, make sure to checkout Part 1.
In part 1 we created our fancy Rails API, setup the authentication and defined a resource for our tiny clone of Medium.
Time to reach the core of this post: the frontend.</p>

<!-- More -->


<h1>Settin up the frontend</h1>

<p>The whole idea behind splitting the backend from the fronted is to treat the web UI as a first class citizen, sitting in its own folder, in its own repo, with no bindings from the backend. The backend can be easily interchanged, as long as the API specs remain consistent. So we&rsquo;ll create a new app from scratch. We have the option to use automated tools like Yeoman, but I wasn&rsquo;t able to find the solution that fit all my need.</p>

<h2>Tools</h2>

<p>I&rsquo;ll be using node&rsquo;s NPM to fetch the main tools, Gulp for the build and watch tasks, and Bower for the resources.
Before diving in the details, I have to warn you, I&rsquo;m awful with gulp, I&rsquo;m still learning, so I pretty much gathered tasks around the web. So take my gulp file lightly, I&rsquo;m planning on fixing all the horrors as soon as I can.
You&rsquo;ll find the package.sjon and gulpfile.js in the sample repo, to make a longstory short we&rsquo;ll be using React.js (obviously), react-router, superagent for the ajax calls and flux. As I said before, Flux is just an architecture, so what am I importing really in my package.json? Turns out that Facebook release a small library called flux that contains basically the code for a Flux Dispatcher (more on that later), that will cut down the amoun of boilerplate code that we&rsquo;ll need to get started.</p>

<h2>Flux Architecture</h2>

<p>If you already took a stab at Flux you might know this diagram:
<img class="center" src="/images/posts/2015-01-29/flux.png" width="640" height="320" title="&lsquo;Flux architecture&rsquo;" ></p>

<p>It might not be easy to understand at first, but it makes more and more sense while you are implementing all those coloured blocks. Let me shed some light over it.
The leftmost block is our Web API, we built that in the previous part of this blog post, so we are set. Our API will be called by the &ldquo;Web API Utils&rdquo;, that&rsquo;s just a plain JS file making ajax requests. Eventually this JS component will receive an AJAX callback, and needs to update our frontend app. It does that using Actions. An action is just a data sctructure that tells the system what happened and what payload is associated with that action.
There are two types of actions: the one initiaded by a server (e.g.: an AJAX callback) and those initiated by the views (e.g.: the user click a button).
The actions are created through Action Creators, that are really just utility functions that build the action and toss it to the system, or to be more precise, the dispatcher.
the dispatcher is a single object (one per app) that, as the name suggests, dispatches actions to those who registered interest in them. It&rsquo;s just a pub-sub mechanism, plain and simple.
The object that register interest in this actions are called Stores. Stores contain the applciation logic and state. They are similar to a model, but they manage the state of all the objects, not a single record.
Stores are the one offering the state that will be presented by the React views. React views should hold as few state as possible, they should grab the state of the data from a store, and pass the state to their children as props.
That&rsquo;s it really, it seems rather convoluted at first, but an example can clear the fog, let&rsquo;s consider the login process:</p>

<ul>
<li>The user enters his username and password, and clicks Login</li>
<li>The React view handles the click event, grabs the content of the fields and creates an action through an action creator, with the tag <code>LOGIN_REQUEST</code> and a payload with the user&rsquo;s credentials</li>
<li>The Action creator creates the <code>LOGIN_REQUEST</code> with its payload, and alerts the Dispatcher</li>
<li>The Action creator also calls the Web API utils, passing the payload</li>
<li>The Web API Utils perform the AJAX call</li>
<li>The Web API responds authenticating the user, providing the repsonse JSON</li>
<li>The Web API Utils receive the JSON and creates a new action, called LOGIN_RESPONSE, with the JSON as payload.</li>
<li>The dispatcher is notified, and forwards the action to the store(s) that is(are) interesetd in a LOGIN_RESPONSE</li>
<li>The store (e.g.: a SessionStore) gets notified and extracts the payload from the action</li>
<li>The store updates its state (username, auth token and login state set to true)</li>
<li>The store emits its changes</li>
<li>The React views are notified of the changes</li>
<li>The React views can grab the state from the store, and if needed pass the state to their children</li>
</ul>


<p>And that&rsquo;s it. Looks like a lot of work for a simple login, but this pattern can be applied to every action performed by the user or the server. It keeps the main components decoupled, it&rsquo;s easier to maintain, and best of all, everything is tidy, for once.</p>

<p>Ok, that was a mouthful, let&rsquo;s see some code.</p>

<h1>Project stucture</h1>

<p>We&rsquo;ll start with the project structure.
<code>
aa.jsx
</code>
app.jsx will be our mounting point, it will render the app in our html template, nothing fancy:
```javascript
var React = require(&lsquo;react&rsquo;);
var router = require(&lsquo;./stores/RouteStore.react.jsx&rsquo;).getRouter();
window.React = React;</p>

<p>router.run(function (Handler, state) {
  React.render(<Handler/>, document.getElementById(&lsquo;content&rsquo;));
});
```
That&rsquo;s our first taste of React and JSX. JSX is a JS extension that lets us write nodes with a syntax similiar to XML. It&rsquo;s optional, but it cleans up the syntax and can be handled with ease by designers.</p>

<h2>Routes</h2>

<p><code>router.jsx</code> holds all of our routes that will be used to instantiate react-router:
```javascript
var React = require(&lsquo;react&rsquo;);
var Router = require(&lsquo;react-router&rsquo;);
var Route = Router.Route;
var DefaultRoute = Router.DefaultRoute;</p>

<p>var SmallApp = require(&lsquo;./components/SmallApp.react.jsx&rsquo;);
var LoginPage = require(&lsquo;./components/session/LoginPage.react.jsx&rsquo;);
var StoriesPage = require(&lsquo;./components/stories/StoriesPage.react.jsx&rsquo;);
var StoryNew = require(&lsquo;./components/stories/StoryNew.react.jsx&rsquo;);
var SignupPage = require(&lsquo;./components/session/SignupPage.react.jsx&rsquo;);</p>

<p>module.exports = (
  <Route name="app" path="/" handler={SmallApp}></p>

<pre><code>&lt;DefaultRoute handler={StoriesPage} /&gt;
&lt;Route name="login" path="/login" handler={LoginPage}/&gt;
&lt;Route name="signup" path="/signup" handler={SignupPage}/&gt;
&lt;Route name="stories" path="/stories" handler={StoriesPage}&gt;
  &lt;Route name="new-story" path="/stories/new" handler={StoryNew}/&gt;
&lt;/Route&gt;
</code></pre>

<p>  </Route>
);
```
Routes are expressed in JSX syntax, we can specify a name (that will be used to perform transitions and to create links), an handler (the React component that will be mounted when the route is visited) and an optional path (that the user will see in his address bar). As you can see we can also mount routes inside another route in a RESTful way.</p>

<h2>Dispatcher</h2>

<p>The dispatcher is the core of the app really, it&rsquo;s the central hub for our messages (actions). It&rsquo;s also a failry easy component to implement, it&rsquo;s really just boilerplate code:
```javascript
var SmallConstants = require(&lsquo;../constants/SmallConstants.js&rsquo;);
var Dispatcher = require(&lsquo;flux&rsquo;).Dispatcher;
var assign = require(&lsquo;object-assign&rsquo;);</p>

<p>var PayloadSources = SmallConstants.PayloadSources;</p>

<p>var SmallAppDispatcher = assign(new Dispatcher(), {</p>

<p>  handleServerAction: function(action) {</p>

<pre><code>var payload = {
  source: PayloadSources.SERVER_ACTION,
  action: action
};
this.dispatch(payload);
</code></pre>

<p>  },</p>

<p>  handleViewAction: function(action) {</p>

<pre><code>var payload = {
  source: PayloadSources.VIEW_ACTION,
  action: action
};
this.dispatch(payload);
</code></pre>

<p>  }
});</p>

<p>module.exports = SmallAppDispatcher;
<code>
We are basically defining two main methods that will be used to dispatch a message. We use two instead of one just for semantics: one will handle the dispatch of server-initiated action, the other one the view-initiated actions.  
Beofre proceding to the meat of the implementation we'll take a look at the Constants file:
</code>javascript
var keyMirror = require(&lsquo;keymirror&rsquo;);</p>

<p>var APIRoot = &ldquo;<a href="http://localhost:3000">http://localhost:3000</a>&rdquo;;</p>

<p>module.exports = {</p>

<p>  APIEndpoints: {</p>

<pre><code>LOGIN:          APIRoot + "/v1/login",
REGISTRATION:   APIRoot + "/v1/users",
STORIES:        APIRoot + "/v1/stories"
</code></pre>

<p>  },</p>

<p>  PayloadSources: keyMirror({</p>

<pre><code>SERVER_ACTION: null,
VIEW_ACTION: null
</code></pre>

<p>  }),</p>

<p>  ActionTypes: keyMirror({</p>

<pre><code>// Session
LOGIN_REQUEST: null,
LOGIN_RESPONSE: null,

// Routes
REDIRECT: null,

LOAD_STORIES: null,
RECEIVE_STORIES: null,
CREATE_STORY: null,
RECEIVE_CREATED_STORY: null
</code></pre>

<p>  })</p>

<p>};
```
This is just an utility class that holds the constants that we&rsquo;ll use throughout the project, mainly the API endpoint and the types of action that we can perform in our app.
Now, let&rsquo;s talk about the authentication process.</p>

<h1>Authentication</h1>

<p>As explained in the Flux example above, the data flow will be initiaded by the user, that will visit the login page, fill a form with his credentials and click on submit. We&rsquo;ll handle the submit as a <code>VIEW_ACTION</code>, this means that our view will just calla  method of our action creator for the session. Let&rsquo;s take a look at it:
```javascript
// ./scripts/actions/SessionActionCreators.react.jsx
var SmallAppDispatcher = require(&lsquo;../dispatcher/SmallAppDispatcher.js&rsquo;);
var SmallConstants = require(&lsquo;../constants/SmallConstants.js&rsquo;);
var WebAPIUtils = require(&lsquo;../utils/WebAPIUtils.js&rsquo;);</p>

<p>var ActionTypes = SmallConstants.ActionTypes;</p>

<p>module.exports = {</p>

<p>  signup: function(email, password, passwordConfirmation) {</p>

<pre><code>SmallAppDispatcher.handleViewAction({
  type: ActionTypes.SIGNUP_REQUEST,
  email: email,
  password: password,
  passwordConfirmation: passwordConfirmation
});
WebAPIUtils.signup(email, password, passwordConfirmation);
</code></pre>

<p>  },</p>

<p>  login: function(email, password) {</p>

<pre><code>SmallAppDispatcher.handleViewAction({
  type: ActionTypes.LOGIN_REQUEST,
  email: email,
  password: password
});
WebAPIUtils.login(email, password);
</code></pre>

<p>  },</p>

<p>  logout: function() {</p>

<pre><code>SmallAppDispatcher.handleViewAction({
  type: ActionTypes.LOGOUT
});
</code></pre>

<p>  }</p>

<p>};
<code>
This cover all the user-initiaded action in the context of the session. The login action creator as you can see creates a new ViewAction, attaching a payload with the user's email and password, and then calls the WebAPIUtils.login method. If other components registered their interest in receiving the LOGIN_REQUEST action, the dispatcher would deliver this action right now.  
The login method of our WebAPIUtils class is this:
</code>javascript
var ServerActionCreators = require(&lsquo;../actions/ServerActionCreators.react.jsx&rsquo;);
var request = require(&lsquo;superagent&rsquo;);</p>

<p>module.exports = {</p>

<p>  login: function(email, password) {</p>

<pre><code>request.post('http://localhost:3002/v1/login')
  .send({ username: email, password: password, grant_type: 'password' })
  .set('Accept', 'application/json')
  .end(function(error, res){
    if (res) {
      if (res.error) {
        var errorMsgs = _getErrors(res);
        ServerActionCreators.receiveLogin(null, errorMsgs);
      } else {
        json = JSON.parse(res.text);
        ServerActionCreators.receiveLogin(json, null);
      }
    }
  });
</code></pre>

<p>  },
  // &hellip;
};
<code>
A common pattern should start to be apparent right now: no class is directly modifying the state of another, but they are just creating new actions. That's the Flux way of handling data in a nutshell.  
To keep things tidy the actions for results of the login process are created in a separate actionc reator:
</code>javascript
// ./scripts/actions/ServerActionCreators.react.jsx
var SmallAppDispatcher = require(&lsquo;../dispatcher/SmallAppDispatcher.js&rsquo;);
var SmallConstants = require(&lsquo;../constants/SmallConstants.js&rsquo;);</p>

<p>var ActionTypes = SmallConstants.ActionTypes;</p>

<p>module.exports = {</p>

<p>  receiveLogin: function(json, errors) {</p>

<pre><code>SmallAppDispatcher.handleServerAction({
  type: ActionTypes.LOGIN_RESPONSE,
  json: json,
  errors: errors
});
</code></pre>

<p>  },</p>

<p>  receiveStories: function(json) {</p>

<pre><code>SmallAppDispatcher.handleServerAction({
  type: ActionTypes.RECEIVE_STORIES,
  json: json
});
</code></pre>

<p>  },</p>

<p>  receiveCreatedStory: function(json, errors) {</p>

<pre><code>SmallAppDispatcher.handleServerAction({
  type: ActionTypes.RECEIVE_CREATED_STORY,
  json: json,
  errors: errors
});
</code></pre>

<p>  }</p>

<p>};
```
And this covers the server and view actions for the login process. Who handles the result though? Let&rsquo;s talk about stores.</p>

<h2>Sessionstore</h2>

<p>Stores are like a mix between a model and a controller, they handle the data, the mains tate of the application, feeding the records to the views, while retrieving the data from a server. We are about to see the SessionStore, which keeps track of the current user (and holds his access token, used in the API calls) and listens for the LOGIN_RESPONSE action.
```javascript
var SmallAppDispatcher = require(&lsquo;../dispatcher/SmallAppDispatcher.js&rsquo;);
var SmallConstants = require(&lsquo;../constants/SmallConstants.js&rsquo;);
var EventEmitter = require(&lsquo;events&rsquo;).EventEmitter;
var assign = require(&lsquo;object-assign&rsquo;);</p>

<p>var ActionTypes = SmallConstants.ActionTypes;
var CHANGE_EVENT = &lsquo;change&rsquo;;</p>

<p>// Load an access token from the session storage, you might want to implement
// a &lsquo;remember me&rsquo; using localSgorage
var <em>accessToken = sessionStorage.getItem(&lsquo;accessToken&rsquo;)
var </em>email = sessionStorage.getItem(&lsquo;email&rsquo;)
var _errors = [];</p>

<p>var SessionStore = assign({}, EventEmitter.prototype, {</p>

<p>  emitChange: function() {</p>

<pre><code>this.emit(CHANGE_EVENT);
</code></pre>

<p>  },</p>

<p>  addChangeListener: function(callback) {</p>

<pre><code>this.on(CHANGE_EVENT, callback);
</code></pre>

<p>  },</p>

<p>  removeChangeListener: function(callback) {</p>

<pre><code>this.removeListener(CHANGE_EVENT, callback);
</code></pre>

<p>  },</p>

<p>  isLoggedIn: function() {</p>

<pre><code>return _accessToken ? true : false;    
</code></pre>

<p>  },</p>

<p>  getAccessToken: function() {</p>

<pre><code>return _accessToken;
</code></pre>

<p>  },</p>

<p>  getEmail: function() {</p>

<pre><code>return _email;
</code></pre>

<p>  },</p>

<p>  getErrors: function() {</p>

<pre><code>return _errors;
</code></pre>

<p>  }</p>

<p>});</p>

<p>SessionStore.dispatchToken = SmallAppDispatcher.register(function(payload) {
  var action = payload.action;</p>

<p>  switch(action.type) {</p>

<pre><code>case ActionTypes.LOGIN_RESPONSE:
  if (action.json &amp;&amp; action.json.access_token) {
    _accessToken = action.json.access_token;
    _email = action.json.email;
    // Token will always live in the session, so that the API can grab it with no hassle
    sessionStorage.setItem('accessToken', _accessToken);
    sessionStorage.setItem('email', _email);
  }
  if (action.errors) {
    _errors = action.errors;
  }
  SessionStore.emitChange();
  break;

case ActionTypes.LOGOUT:
  _accessToken = null;
  _email = null;
  sessionStorage.removeItem('accessToken');
  sessionStorage.removeItem('email');
  SessionStore.emitChange();
  break;

default:
</code></pre>

<p>  }</p>

<p>  return true;
});</p>

<p>module.exports = SessionStore;
```
That looks like a bunch of code, but most of it is boilerplate, the interesting part is in the .register function. When the store receives the LOGIN_RESPONSE action unpacks the payload and checks wether the login was successfull or not. It then updates its state (that will be accessed by the public properties declared on top of the file) and notifies a change to whomever might be listening (that&rsquo;s why we import node&rsquo;s EventEmitter and merge the class with it).<br/>
Ok, we have the ability to send a view action, we receive the result and store it, cool, now we need to use this store somewhere and show some UI already.</p>

<h2>Application</h2>

<p>Having a store and a state brings up a tricky question: who should listen to its changes and who should use its state? Following the React philosophy we should find the component at the topmost of our view&rsquo;s tree, without bloating the component itself though. As far as session goes I think the best place is the root of our app. The root is the first component that is mounted by the routes, and if you take a look at our routes, that would be SmallApp:
```javascript
// ./scripts/components/SmallApp.react.jsx
var React = require(&lsquo;react&rsquo;);
var RouteHandler = require(&lsquo;react-router&rsquo;).RouteHandler;
var Header = require(&lsquo;../components/Header.react.jsx&rsquo;);
var SessionStore = require(&lsquo;../stores/SessionStore.react.jsx&rsquo;);
var RouteStore = require(&lsquo;../stores/RouteStore.react.jsx&rsquo;);</p>

<p>function getStateFromStores() {
  return {</p>

<pre><code>isLoggedIn: SessionStore.isLoggedIn(),
email: SessionStore.getEmail()
</code></pre>

<p>  };
}</p>

<p>var SmallApp = React.createClass({</p>

<p>  getInitialState: function() {</p>

<pre><code>return getStateFromStores();
</code></pre>

<p>  },</p>

<p>  componentDidMount: function() {</p>

<pre><code>SessionStore.addChangeListener(this._onChange);
</code></pre>

<p>  },</p>

<p>  componentWillUnmount: function() {</p>

<pre><code>SessionStore.removeChangeListener(this._onChange);
</code></pre>

<p>  },</p>

<p>  _onChange: function() {</p>

<pre><code>this.setState(getStateFromStores());
</code></pre>

<p>  },</p>

<p>  render: function() {</p>

<pre><code>return (
  &lt;div className="app"&gt;
    &lt;Header 
      isLoggedIn={this.state.isLoggedIn}
      email={this.state.email} /&gt;
    &lt;RouteHandler/&gt;
  &lt;/div&gt;
);
</code></pre>

<p>  }</p>

<p>});</p>

<p>module.exports = SmallApp;
```
This is a really simple component that serves as the root layout. If you take a look at the render function you can see that it only renders a React component named Header and then mounts the content of the Router. The header has a couple of properties though (React props to be exact) and we fill them using the SmallApp state. Those props will be accessible from the Header component. The  SmallApp state is obtained by querying the SessionStore.</p>

<h2>LoginPage</h2>

<h2>RegisterPage</h2>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[React + Flux backed by Rails API - Part 1]]></title>
    <link href="http://andreamazz.github.io/blog/2015/01/28/react-plus-flux-backed-by-rails-api/"/>
    <updated>2015-01-28T16:04:00+01:00</updated>
    <id>http://andreamazz.github.io/blog/2015/01/28/react-plus-flux-backed-by-rails-api</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve been working on a frontend for a project we are developing over at Fancy Pixel. We are embracing what looks like a good habit: slicing the monolithic Rails app in a backend serving APIs and a frontend consuming them. We did this in the not so distant past using Angular.js. It was all fine and dandy, until it wasn&rsquo;t. There&rsquo;s something about it that doesn&rsquo;t sit right with me, I wouldn&rsquo;t go in detail, since many others already did, but let&rsquo;s just say that there&rsquo;s too much magic involved for my tastes (says the guy using Rails). I can&rsquo;t deny that the major structural changes introduced in 2.0 were the last nail in the coffin. I wanted to try something new, something that would enforce a solid architecture of my app, letting me control the single parts. React got a lot of good press in the past months, so I took the chance to dive in. Here you&rsquo;ll find pretty much everything I learned by writing a frontend using React, with a vanilla Flux architecture, consuming an API written in Rails.</p>

<!-- More -->


<h2>Choosing the backend</h2>

<p>Given our experience, the obvious choice for us was Rails, but with a twist: rails-api. Rails-api is a stripped down version of Rails, where most of the &lsquo;useless&rsquo; middleware is not included (but you can iclude it if you need it). Using Rails to serve JSON might seem overkill, but the Github page of rails-api has some really good points to counter this argument.</p>

<h2>The frontend technology</h2>

<p>The real meat of this post, I picked React for building the views. React is javascript library for building user interfaces built and open sourced by the Facebook&rsquo;s engineers. Its major selling point is the ability to provide a dynamic and fast way to build isomorphic apps. Isomorphic means that the app can be rendered with ease on both the server and the client, which helps with SEO. I&rsquo;ll be honest, I don&rsquo;t give a flying f&hellip; udge about SEO, I was sold by the Virtual DOM and how the data is organized and handled in React views.
The Virtual DOM is something that we&rsquo;re going to see implemented in other JS frameworks (Ember does that already if I&rsquo;m not mistaken). The views can be rendered on the server for the initial request, than the underliyng tech is going to render subsequent pages in a Virtual DOM, that is then diffed with the actual DOM, and then only the differences are changes in the visible page. And it&rsquo;s fast. Brilliant.</p>

<h2>Flux</h2>

<p>This covers the backend and the views, we&rsquo;re missing something in between, say, an architecture to follow. Flux is an architecture for building web UIs, and works really well in compination with React, but it can really be applied anywhere.</p>

<h2>Here comes trouble</h2>

<p>I never was a big fan of implementing web UI, CSS always gets messy, Javascript files become scary monoliths where crappy code goes to die, while developers test their spelunker skills and loose their sanity. Maybe I&rsquo;m just crap, but even using Sass anc Coffee/Typescript never really solved my issues. I was excited to try something really new, little did I know that using bleeding edge tech is a pain in the butt. Ok, I DID now that, but I was naive enough to think that maybe this time everything was going to be different.
The PITA was learning and being productive. It took a while, there&rsquo;s still not a clear &ldquo;best practice&rdquo; to perform common tasks, nor a clear starting configuration. Let&rsquo;s put it that way, if you come from the RoR world, where convention over configuration greatly reduced boilerplating and &ldquo;forced&rdquo; you to follow commonly established best practice, you&rsquo;re going to struggle with Flux. Hey, I figured it out, so it&rsquo;s not that big of a deal.</p>

<h1>Getting it all toghether</h1>

<p>Let&rsquo;s start writing some code. We&rsquo;ll go through a simple Rails app, it will feature user signup and login, and the ability to post a story. Just like Medium, but in a smaller size. Let&rsquo;s call it Small. Feel free to skip the Railsy part if you&rsquo;re only interested in Flux and React.</p>

<h1>Rails API</h1>

<p>A while ago I stumbled upon <a href="http://slides.com/alanpeabody/breaking-up-with-the-asset-pipeline#/">this article</a> by Alan Peabody. I had a similar experience as him, as the title say, I too feel the need to break up with Rails' asset pipeline and make Rails beautiful again. We&rsquo;ll be using the rails-api gem. You can generate a new app with its CLI command, or you can integrate it later. I&rsquo;ll do the later option, no reason really, just a habit.
<code>
rails new small
</code>
Next we&rsquo;ll add rails-api, devise, active model serializers gems to our gemfile, and while we are at it we can remove all the gems that generate assets or view content, jbuilder included. Our Gemfile should look like this (test section omitted):
```ruby
source &lsquo;<a href="https://rubygems.org">https://rubygems.org</a>&rsquo;</p>

<p>gem &lsquo;rails&rsquo;, &lsquo;4.2.0&rsquo;
gem &lsquo;rails-api&rsquo;, &lsquo;~> 0.4.0&rsquo;
gem &lsquo;active_model_serializers&rsquo;, &lsquo;~> 0.8.3&rsquo; # NOTE: not the 0.9
gem &lsquo;devise&rsquo;, &lsquo;~> 3.4.1&rsquo;
gem &lsquo;sqlite3&rsquo;
gem &lsquo;sdoc&rsquo;, &lsquo;~> 0.4.0&rsquo;, group: :doc</p>

<p>group :development, :test do
  gem &lsquo;byebug&rsquo;
  gem &lsquo;web-console&rsquo;, &lsquo;~> 2.0&rsquo;
  gem &lsquo;spring&rsquo;
end
<code>
Now we need to change the application controller so that it inherits from ActionController::API, and kiss the protect_From_forgery goodbye. Since we are serving only JSON, it makes sense to add
</code>ruby
respond_to :json
```
to the applciation controller, helps DRYing all out.</p>

<h2>Authentication</h2>

<p>Should I first define a resurce? Maybe, but that&rsquo;s trivial, let&rsquo;s get the authentication out of the way. We are building an API, so no session will be involved, we have to authenticate the user in each request. I&rsquo;ll be using <a href="http://oauthlib.readthedocs.org/en/latest/oauth2/grants/password.html">Oauth2 Resource Owner Password Credentials Grant</a> which sounds fancy, but it&rsquo;s really just a token in the request header that authenticates the caller. The gem Devise used to implement a token_authenticatable strategy, but it was pulled for security reason. There are gems that implement the strategy (like Doorkeeper), but since it&rsquo;s fairly easy to implement I&rsquo;ll do it for myself. Let&rsquo;s install Devise first by adding it in the Gemfile and launching <code>rails generate devise:install</code> after a <code>bundle install</code>, then we create the user model:
<code>ruby
rails generate devise User
</code></p>

<h2>Token authentication</h2>

<p>Token authentication was removed from Devise a couple of years ago, <a href="http://blog.plataformatec.com.br/2013/08/devise-3-1-now-with-more-secure-defaults/">this link</a> explains why. We have to implement it for ourselves, but it&rsquo;s quite easy. The token will be composed of two information: the user&rsquo;s id followed by the token itself, separated by a <code>:</code>. We&rsquo;ll be using the user&rsquo;s database id for this sample, for semplicity&rsquo;s sake, but it&rsquo;s obviously not a smart thing to do.
First things first, we&rsquo;ll add an access_token to the user:
```ruby
class AddAccessTokenToUser &lt; ActiveRecord::Migration
  def change</p>

<pre><code>add_column :users, :access_token, :string
</code></pre>

<p>  end
end
<code>
and here's the User model:
</code>ruby
class User &lt; ActiveRecord::Base
  devise :database_authenticatable, :recoverable, :validatable</p>

<p>  after_create :update_access_token!</p>

<p>  private</p>

<p>  def update_access_token!</p>

<pre><code>self.access_token = generate_access_token
save
</code></pre>

<p>  end</p>

<p>  def generate_access_token</p>

<pre><code>loop do
  token = "#{self.id}:#{Devise.friendly_token}"
  break token unless User.where(access_token: token).first
end
</code></pre>

<p>  end</p>

<p>end
<code>
The user authentication will sit in the application controller:
</code>ruby
class ApplicationController &lt; ActionController::API
  before_action :authenticate_user_from_token!
  include AbstractController::Translation</p>

<p>  respond_to :json</p>

<p>  ##
  # User Authentication
  # Authenticates the user with OAuth2 Resource Owner Password Credentials Grant
  def authenticate_user_from_token!</p>

<pre><code>auth_token = request.headers['Authorization']

if auth_token
  authenticate_with_auth_token auth_token
else
  authentication_error
end
</code></pre>

<p>  end</p>

<p>  private</p>

<p>  def authenticate_with_auth_token auth_token</p>

<pre><code>unless auth_token.include?(':')
  authentication_error
  return
end

user_id = auth_token.split(':').first
user = User.where(id: user_id).first

if user &amp;&amp; Devise.secure_compare(user.access_token, auth_token)
  # User can access
  sign_in user, store: false
else
  authentication_error
end
</code></pre>

<p>  end</p>

<p>  ##
  # Authentication Failure
  # Renders a 401 error
  def authentication_error</p>

<pre><code># User's token is either invalid or not in the right format
render json: {error: t('application_controller.unauthorized')}, status: 401  # Authentication timeout
</code></pre>

<p>  end
end
<code>
We conclude the auth process by providing the routes and the session controller:
</code>ruby
Rails.application.routes.draw do
  devise_for :user, only: []</p>

<p>  namespace :v1, defaults: { format: :json } do</p>

<pre><code>resource :login, only: [:create], controller: :sessions
</code></pre>

<p>  end
end
<code>
and the session controller:
</code>ruby</p>

<h1>app/controllers/v1/sessions_controller.rb</h1>

<p>module V1
  class SessionsController &lt; ApplicationController</p>

<pre><code>skip_before_action :authenticate_user_from_token!

# POST /v1/login
def create
  @user = User.find_for_database_authentication(email: params[:username])
  return invalid_login_attempt unless @user

  if @user.valid_password?(params[:password])
    sign_in :user, @user
    render json: @user, serializer: SessionSerializer, root: nil
  else
    invalid_login_attempt
  end
end

private

def invalid_login_attempt
  warden.custom_failure!
  render json: {error: t('sessions_controller.invalid_login_attempt')}, status: :unprocessable_entity
end
</code></pre>

<p>  end
end
<code>
The SessionSerializer is an Active Model Serializer object, something like this:
</code>ruby</p>

<h1>app/serializers/v1/session_serializer.rb</h1>

<p>module V1
  class SessionSerializer &lt; ActiveModel::Serializer</p>

<pre><code>attributes :email, :token_type, :user_id, :access_token

def user_id
  object.id
end

def token_type
  'Bearer'
end
</code></pre>

<p>  end
end
<code>
That's it. Migrate, run the server, and create a user via the console. You should get something like this:
</code>
$ curl localhost:3002/v1/login &mdash;data &ldquo;username=user@example.com&amp;password=password&rdquo;
{
  &ldquo;token_type&rdquo;: &ldquo;Bearer&rdquo;,
  &ldquo;user_id&rdquo;: 1,
  &ldquo;access_token&rdquo;: &ldquo;1:MPSMSopcQQWr-LnVUySs&rdquo;
}
```</p>

<h2>Creating a resource</h2>

<p>I won&rsquo;t go in detail here, the task is just plain RoR. We&rsquo;ll create a Story resource and a controller that will handle the user creation. You&rsquo;ll find the complete rails app in this repo. Moving on.</p>

<h2>CORS</h2>

<h2>Next up</h2>

<p>For readability I&rsquo;ll split the article here, jump here to start building the frontend.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Small updates]]></title>
    <link href="http://andreamazz.github.io/blog/2015/01/26/small-updates/"/>
    <updated>2015-01-26T20:57:00+01:00</updated>
    <id>http://andreamazz.github.io/blog/2015/01/26/small-updates</id>
    <content type="html"><![CDATA[<p>I&rsquo;m about to close week 4 of the &ldquo;One icon a day&rdquo; challenge, sometimes it&rsquo;s fun, sometimes it&rsquo;s tough, but I&rsquo;m glad I started this project. Adding some spice to the mix I also started recording what I do, mistakes and brain farts included. You can find the videos in this <a href="https://www.youtube.com/playlist?list=PL9N7C4VLxpJWOW8Au9VZyVXcR1lRFnMKD">Youtube playlist</a>.</p>

<!-- More -->


<p>Speaking of icons, a Reddit user suggested to put the resulting icons on <a href="http://thenounproject.com/">the NounProject</a>. I should have thought about this before, I mean, I really wish I thought about this before, because they have some requirements that differ a bit from what I&rsquo;ve been doing. No strokes for starters, which sucks since I&rsquo;ve been using them like it&rsquo;s my job. Other than that, it&rsquo;s gonna be <a href="https://www.youtube.com/watch?v=QetvK6ldl2s">smooth sailing</a>.</p>

<h2>Being a developer</h2>

<p>Let&rsquo;s talk about writing code for a while.<br/>
I took a pause from iOS in the past few months, I&rsquo;m not happy about it, but to face some pressing matters I had to put my web developer&rsquo;s clothes on.
In the end, I&rsquo;m glad, since I had a chance to choose and tinker with new stuff. First of all, I took the full API backed frontend route, using <a href="https://github.com/rails-api/rails-api">rails-api</a> (a stripped down version of Rails) to provide data for a React web app, implemented with a vanilla Flux architecture.</p>

<p>React and Flux are the new kids on the block, the documentation and community are still almost a work in progress, and there are little to no patterns to follow, even for the most trivial stuff as performing async requests or authenticating a user.
I scratched my head for a while, but in the end I&rsquo;ve learned quite a bit, and I&rsquo;m liking this new way of writing frontend apps more and more every day.</p>

<p>I&rsquo;m planning on writing all down in an article in the next few days, covering all: setup, the Flux architecture, authenticating the user with a token, performing async requests.<br/>
Until next time.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Fun with iBeacon]]></title>
    <link href="http://andreamazz.github.io/blog/2014/07/01/fun-with-ibeacon/"/>
    <updated>2014-07-01T20:47:00+02:00</updated>
    <id>http://andreamazz.github.io/blog/2014/07/01/fun-with-ibeacon</id>
    <content type="html"><![CDATA[<p>You probably know already what <a href="https://developer.apple.com/library/ios/documentation/userexperience/conceptual/LocationAwarenessPG/RegionMonitoring/RegionMonitoring.html">iBeacon</a> is, but just to reiterate, iBeacon is the Apple way of saying Bluetooth 4 Low Energy. At the cost of sounding like a mindless drone, by &lsquo;the Apple way of&rsquo; I mean &lsquo;it just works and shows a lot of potential&rsquo;. An iBeacon is a simple B4LE device that keeps broadcasting its presence. Other B4LE devices can sense when they reach the beacon without draining the battery (hence the LE) and making the user scream in agony. &ldquo;Oook, what do I do with it?&rdquo;. The best thing you can do is locating a user without the GPS, which means locating a user inside a building. The cool thing is that it&rsquo;s fast, it takes seconds to detect a beacon and to react to its vicinity (or lack there of), and it works within the reach of Bluetooth technology (let&rsquo;s say around a 50 meters radius). I should also mention that it works fine with Android too. (<em>Update: look at the end of the post for the sources of the Android version</em>)
This week an <a href="http://estimote.com">Estimote</a> developer kit arrived in the Fancy Pixel&rsquo;s offices, so we took the chance to play around with it.</p>

<!-- More -->


<p>I already tried my hand with iBeacons in the not so distant past. Using <a href="https://github.com/lgaches/BeaconEmitter">BeaconEmitter</a> you can easily turn your Mac into a beacon, with no extra hardware required. When I experimented with iBeacons I had a couple of ideas on my mind, that involved being able to send a local notification to the user that enters in range of a device acting as a beacon. My dreams were crushed by the limits of the iOS 7.0 implementation, as I found out that:</p>

<ul>
<li>you can&rsquo;t react when the user&rsquo;s screen is turned off</li>
<li>you can&rsquo;t perform any action when your app is in background, even if you request the <code>location</code> background state</li>
<li>detecting when the user leaves a region takes quite a lot of time (at least 10/15 minutes)</li>
</ul>


<p>The most exciting thing about playing around with the Estimote SDK, besides the nifty packaging and well designed piece of hardware, is that my devices now have iOS 7.1. It turns out that with version 7.1, iOS is way more flexible and it&rsquo;s taking care of all the problems I faced with 7.0:</p>

<ul>
<li>you can show a local notification when the screen is off</li>
<li>you can perform operations when the user enters a region (even if the app was killed)</li>
<li>it takes second to detect when the user is out of range</li>
</ul>


<p>This turns everything around, iBeacons aren&rsquo;t just a gimmick now, but an exciting tool to experiment with.</p>

<h2>Building a sample</h2>

<p>First thing that came to our mind was to build a simple system to automatically check people in and out of the office. Really, as simple as it gets, it took a couple of hours to build, but it works surprisingly well.</p>

<h3>Rails backend</h3>

<p>To check people in and out we need a backend and an authentication system. Rails makes it easy, a model, a basic API and the help of Devise for the authentication process.
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>app/model/checkin.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Checkin</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  belongs_to :user&lt;br/</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">enum</span> <span class="ss">direction</span><span class="p">:</span> <span class="p">{</span> <span class="k">in</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="ss">out</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
That&rsquo;s a pretty basic model, taking advantage of Rails 4.1 enums.</p>

<p>The routes are scoped as APIs, just to be fancy:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>config/routes.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">namespace</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">defaults</span><span class="p">:</span> <span class="p">{</span><span class="nb">format</span><span class="p">:</span> <span class="ss">:json</span><span class="p">}</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">namespace</span> <span class="ss">:v1</span> <span class="k">do</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;post &#39;checkin&#39;, to: &#39;checkins#checkin&#39;</span>
</span><span class='line'><span class="sr">post &#39;checkout&#39;, to: &#39;checkins#checkout&#39;</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  end</span>
</span><span class='line'><span class="sr">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>And the controller does pretty much just this:
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>checkins_controller.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">checkin</span>
</span><span class='line'>  <span class="n">checkin</span> <span class="o">=</span> <span class="no">Checkin</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">user</span><span class="p">:</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">direction</span><span class="p">:</span> <span class="ss">:in</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">checkin</span><span class="o">.</span><span class="n">save</span><span class="o">&lt;</span><span class="sr">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;pre&gt;&lt;code&gt;head :no_content</span>
</span><span class='line'><span class="sr">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;</span><span class="sr">/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">&lt;p&gt;  else&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="p">{</span><span class="ss">errors</span><span class="p">:</span> <span class="n">checkin</span><span class="o">.</span><span class="n">errors</span><span class="p">},</span> <span class="ss">status</span><span class="p">:</span> <span class="ss">:unprocessable_entity</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/code&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The authentication is handled by Devise, and for simplicity we opted for HTTP Basic Authentication.</p>

<h3>iOS Client</h3>

<p>The iOS app needs to look for our trusty beacon, and once the user is in range of our region, it needs to make a POST call to our API. When the user walks out of the office the phone needs to do the same to the checkout API. The iOS APIs for handling beacons are inside CoreLocation, in this sample I&rsquo;ll be using two main delegate methods:
<div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="o">&amp;</span><span class="n">ndash</span><span class="p">;</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="p">)</span><span class="n">manager</span> <span class="nl">didEnterRegion:</span><span class="p">(</span><span class="n">CLRegion</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="p">)</span><span class="n">region</span><span class="p">;</span>
</span><span class='line'><span class="o">&amp;</span><span class="n">ndash</span><span class="p">;</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="p">)</span><span class="n">manager</span> <span class="nl">didExitRegion:</span><span class="p">(</span><span class="n">CLRegion</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="p">)</span><span class="n">region</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>The good guy calling these two methods is a <code>CLLocationManager</code> instance. The location manager needs an instance of <code>CLBeaconRegion</code> to start doing its magic though. We can define a region by specifying a UUDID, an identifier, a major and a minor. It might sound confusing at first, but all those things boil down to this:</p>

<ul>
<li><code>UUDID</code>: A unique identifier of our beacon network. It&rsquo;s best practice to have one UUDID per App. Each beacon will share the same UUDID.</li>
<li><code>identifier</code>: It&rsquo;s a string representation of our network. It usually is the reverse URI of our App, something along the line of com.something.awesome.</li>
<li><code>major</code>: It&rsquo;s an integer that specifies the major group of our beacons. Think of it as a common number that can identify a bunch of beacons inside a building.</li>
<li><code>minor</code>: It&rsquo;s an integer that specifies the single beacon inside of a major group.</li>
</ul>


<p>So our basic config would be one UUDID and identifier per App, one major per building, and one minor per beacon. For the purposes of this sample we only have a beacon, so we can either disregard this info, or just specify whatever major and minor that we want, as long as it matches the ones configured in the beacon itself.
Now that all that is out of the way, let&rsquo;s get to the code:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="o">&amp;</span><span class="n">ndash</span><span class="p">;</span> <span class="p">(</span><span class="n">CLBeaconRegion</span> <span class="o">*</span><span class="p">)</span><span class="n">region</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">if</span> <span class="p">(</span><span class="n">_region</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSUUID</span> <span class="o">*</span><span class="n">proximityUUID</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSUUID</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithUUIDString:</span><span class="n">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">@&quot;udid&quot;</span><span class="p">]];</span>
</span><span class='line'>    <span class="n">_region</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CLBeaconRegion</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithProximityUUID:</span><span class="n">proximityUUID</span>
</span><span class='line'>                                                      <span class="nl">major:</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">@&quot;major&quot;</span><span class="p">]</span> <span class="n">intValue</span><span class="p">]</span>
</span><span class='line'>                                                      <span class="nl">minor:</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">@&quot;minor&quot;</span><span class="p">]</span> <span class="n">intValue</span><span class="p">]</span>
</span><span class='line'>                                                 <span class="nl">identifier:</span><span class="n">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">@&quot;identifier&quot;</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">_region</span> <span class="nl">setNotifyOnExit:</span><span class="n">YES</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">_region</span> <span class="nl">setNotifyOnEntry:</span><span class="n">YES</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">_region</span> <span class="nl">setNotifyEntryStateOnDisplay:</span><span class="n">YES</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">return</span> <span class="n">_region</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
There we go, our lazy loaded region that reads the parameters from an NSDictionary. Cool, let&rsquo;s start monitoring:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">manager</span> <span class="nl">startMonitoringForRegion:</span><span class="n">self</span><span class="p">.</span><span class="n">region</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">manager</span> <span class="nl">stopRangingBeaconsInRegion:</span><span class="n">self</span><span class="p">.</span><span class="n">region</span><span class="p">];</span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
The first line is pretty self explanatory, the second one just tells the system that I don&rsquo;t really care for the single beacons, I just need the region updates.</p>

<p>Now that we are monitoring the region, we just need to decide what to do when we are in and out of range:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="o">&amp;</span><span class="n">ndash</span><span class="p">;</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="p">)</span><span class="n">manager</span> <span class="nl">didEnterRegion:</span><span class="p">(</span><span class="n">CLRegion</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="p">)</span><span class="n">region</span>
</span><span class='line'><span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="k">if</span> <span class="p">([</span><span class="n">region</span> <span class="nl">isKindOfClass:</span><span class="p">[</span><span class="n">CLBeaconRegion</span> <span class="n">class</span><span class="p">]])</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">CLBeaconRegion</span> <span class="o">*</span><span class="n">beaconRegion</span> <span class="o">=</span> <span class="p">(</span><span class="n">CLBeaconRegion</span> <span class="o">*</span><span class="p">)</span><span class="n">region</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">([</span><span class="n">beaconRegion</span><span class="p">.</span><span class="n">identifier</span> <span class="nl">isEqualToString:</span><span class="n">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">@&quot;identifier&quot;</span><span class="p">]]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">[</span><span class="n">beaconRegion</span><span class="p">.</span><span class="n">major</span> <span class="n">intValue</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">@&quot;major&quot;</span><span class="p">]</span> <span class="n">intValue</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">[</span><span class="n">beaconRegion</span><span class="p">.</span><span class="n">minor</span> <span class="n">intValue</span><span class="p">]</span><span class="o">==</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">@&quot;minor&quot;</span><span class="p">]</span> <span class="n">intValue</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">UILocalNotification</span> <span class="o">*</span><span class="n">notification</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UILocalNotification</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>        <span class="n">notification</span><span class="p">.</span><span class="n">userInfo</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;identifier&quot;</span><span class="o">:</span> <span class="n">region</span><span class="p">.</span><span class="n">identifier</span><span class="p">};</span>
</span><span class='line'>        <span class="n">notification</span><span class="p">.</span><span class="n">alertBody</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;Entering %@&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">.</span><span class="n">identifier</span><span class="p">];</span>
</span><span class='line'>        <span class="n">notification</span><span class="p">.</span><span class="n">soundName</span> <span class="o">=</span> <span class="s">@&quot;Default&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[[</span><span class="n">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">presentLocalNotificationNow:</span><span class="n">notification</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span> <span class="nl">remoteCheckin:</span><span class="n">FPCheckDirectionIn</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">locationManager:</span><span class="p">(</span><span class="n">CLLocationManager</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="p">)</span><span class="n">manager</span> <span class="nl">didExitRegion:</span><span class="p">(</span><span class="n">CLRegion</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="p">)</span><span class="n">region</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">([</span><span class="n">region</span> <span class="nl">isKindOfClass:</span><span class="p">[</span><span class="n">CLBeaconRegion</span> <span class="n">class</span><span class="p">]])</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">CLBeaconRegion</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">beaconRegion</span> <span class="o">=</span> <span class="p">(</span><span class="n">CLBeaconRegion</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span><span class="p">)</span><span class="n">region</span><span class="p">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">([</span><span class="n">beaconRegion</span><span class="p">.</span><span class="n">identifier</span> <span class="nl">isEqualToString:</span><span class="n">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="err">@</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">identifier</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;]]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">[</span><span class="n">beaconRegion</span><span class="p">.</span><span class="n">major</span> <span class="n">intValue</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="err">@</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">major</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;]</span> <span class="n">intValue</span><span class="p">]</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span> <span class="p">[</span><span class="n">beaconRegion</span><span class="p">.</span><span class="n">minor</span> <span class="n">intValue</span><span class="p">]</span><span class="o">==</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="err">@</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">minor</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;]</span> <span class="n">intValue</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">UILocalNotification</span> <span class="o">*</span><span class="n">notification</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UILocalNotification</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>          <span class="n">notification</span><span class="p">.</span><span class="n">userInfo</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="err">@</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">identifier</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;</span><span class="o">:</span> <span class="n">region</span><span class="p">.</span><span class="n">identifier</span><span class="p">};</span>
</span><span class='line'>          <span class="n">notification</span><span class="p">.</span><span class="n">alertBody</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="err">@</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">Exiting</span> <span class="o">%</span><span class="err">@</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;,</span> <span class="n">region</span><span class="p">.</span><span class="n">identifier</span><span class="p">];</span>
</span><span class='line'>          <span class="n">notification</span><span class="p">.</span><span class="n">soundName</span> <span class="o">=</span> <span class="err">@</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="n">Default</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="p">;;</span>
</span><span class='line'>          <span class="p">[[</span><span class="n">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">presentLocalNotificationNow:</span><span class="n">notification</span><span class="p">];</span>
</span><span class='line'>          <span class="p">[</span><span class="n">self</span> <span class="nl">remoteCheckin:</span><span class="n">FPCheckDirectionOut</span><span class="p">];</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></li>
</ul>


<p>As you can see, we&rsquo;re just checking against our beacon, when we are in range or when we get out of range, we push a local notification and we perform a remote call to our Rails backend. You can find the full source on our Github account, don&rsquo;t worry.</p>

<h2>Who&rsquo;s Fancy?</h2>

<p>And there we go, the iOS app:</p>

<p><img class="center" src="/images/posts/2014-07-01/iOS.png" title="&lsquo;Who&rsquo;s Fancy iOS&rsquo;" ></p>

<p>and the web page:</p>

<p><img class="center" src="/images/posts/2014-07-01/rails.png" title="&lsquo;Who&rsquo;s Fancy Rails&rsquo;" ></p>

<p>You can find the rails and iOS code <a href="https://github.com/FancyPixel/whosfancy-rails">here</a> and <a href="https://github.com/FancyPixel/whosfancy-ios">here</a>.</p>

<h4>Android version</h4>

<p>Updated: We also pushed the Android version on our Github page, you can find it <a href="https://github.com/FancyPixel/whosfancy-android">here</a>.</p>

<p>Until next time.</p>

<p>Andrea</p>
]]></content>
  </entry>
  
</feed>
